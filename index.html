<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Jornada Flexible</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(180deg, #e4e4e4 0%, #c0c0c0 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: #a0d168;
            border-radius: 15px;
            margin: 15px;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .date-time {
            text-align: center;
            margin-top: 10px;
        }

        #currentDate {
            font-size: 1rem;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #currentTime {
            font-size: 3rem;
            font-weight: bolder;
        }

        .main-content {
            padding: 30px;
        }
 
        .status-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 5px solid #a0d168;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .working {
            color: #28a745;
        }

        .overtime {
            color: #dc3545;
        }

        .action-button {
            width: 100%;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-enter {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-exit {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
        }

        .btn-lunch-out {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }

        .btn-lunch-back {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
            color: white;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .overtime-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .overtime-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .add-btn {
            background: #a0d168;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .history-content {
            display: none;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .history-content.active {
            display: block;
        }

        .manual-entry-content {
            display: none;
            background: #f8f9fa;
            border-radius: 15px;
            border: 5px solid #dddddd;
            padding: 20px;
            margin-top: 15px;
        }

        .manual-entry-content.active {
            display: block;
        }

        .day-record {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4a90e2;
        }

        .day-header {
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-entry {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .overtime-entry {
            color: #dc3545;
            font-style: italic;
            font-weight: bold;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 15px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .edit-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }

            .status-grid {
                grid-template-columns: 1fr 1fr;
            }

            .header h1 {
                font-size: 1.5rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 20% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Control de Jornada Flexible</h1>
            
        </div>

        <div class="date-time">
            <div id="currentDate"></div>
            <div id="currentTime"></div>
        </div>

        <div class="main-content">
            <div id="alertContainer"></div>

            <div class="status-card">
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Estado</div>
                        <div class="status-value" id="workStatus">Fuera</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Horas Trabajadas</div>
                        <div class="status-value" id="workedHours">00:00</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Horas Restantes</div>
                        <div class="status-value" id="remainingHours">--:--</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Hora Estimada Salida</div>
                        <div class="status-value" id="estimatedExit">--:--</div>
                    </div>
                </div>
            </div>

            <div id="actionButtons">
                <button class="action-button btn-enter" id="enterBtn" onclick="handleAction('enter')">
                    Entrada
                </button>
                <button class="action-button btn-lunch-out" id="lunchOutBtn" onclick="handleAction('lunch_out')" style="display: none;">
                    Salir a Comer
                </button>
                <button class="action-button btn-lunch-back" id="lunchBackBtn" onclick="handleAction('lunch_back')" style="display: none;">
                    Volver de Comer
                </button>
                <button class="action-button btn-exit" id="exitBtn" onclick="handleAction('exit')" style="display: none;">
                    Salida
                </button>
            </div>

            <div class="manual-entry">
                <button class="action-button btn-enter" onclick="toggleManualEntry()">Ingreso Manual</button>
                <div class="manual-entry-content" id="manualEntryContent">
                    <div class="form-group">
                        <label for="manualType">Tipo:</label>
                        <select id="manualType">
                            <option value="enter">Entrada</option>
                            <option value="lunch_out">Salida comida</option>
                            <option value="lunch_back">Vuelta comida</option>
                            <option value="exit">Salida</option>
                        </select>
                        <label for="manualTime">Hora:</label>
                        <input type="time" id="manualTime">
                    </div>
                    <button class="add-btn" onclick="addManualEntry()">Agregar</button>
                </div>
            </div>

            <div class="overtime-section" id="overtimeSection">
                <h3>Horario Extraordinario</h3>
                <p>Esta acción está fuera del horario establecido. Por favor, proporciona los detalles:</p>
                
                <div class="form-group">
                    <label for="overtimeReason">Motivo:</label>
                    <select id="overtimeReason">
                        <option value="">Seleccionar motivo...</option>
                        <option value="reunion_urgente">Reunión urgente</option>
                        <option value="proyecto_critico">Proyecto crítico</option>
                        <option value="problema_tecnico">Problema técnico</option>
                        <option value="cliente_importante">Atención cliente importante</option>
                        <option value="formacion">Formación</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="overtimeDescription">Descripción:</label>
                    <input type="text" id="overtimeDescription" placeholder="Describe brevemente la situación...">
                </div>
                
                <button class="confirm-btn" onclick="confirmOvertimeAction()">Confirmar</button>
            </div>

            <div class="history-section">
                <button class="history-toggle" onclick="toggleHistory()">Ver Historial Semanal</button>
                <button class="history-toggle" onclick="exportWeekToExcel()">Exportar a Excel</button>
                <div class="history-content" id="historyContent"></div>
            </div>
        </div>
    </div>

    <div id="editDayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="editDayModalTitle">Editar Jornada</h2>
                <span class="close-btn" onclick="closeEditModal()">&times;</span>
            </div>
            
            <div id="existingEntriesContainer"></div>
            
            <div id="addNewEntrySection">
                <hr style="margin: 20px 0;">
                
                <h3>Añadir Nuevo Registro</h3>
                <div class="form-group">
                    <label for="newEntryType">Tipo:</label>
                    <select id="newEntryType">
                        <option value="enter">Entrada</option>
                        <option value="lunch_out">Salida comida</option>
                        <option value="lunch_back">Vuelta comida</option>
                        <option value="exit">Salida</option>
                    </select>
                    <label for="newEntryTime">Hora:</label>
                    <input type="time" id="newEntryTime">
                </div>
                <button class="add-btn" onclick="addNewEntryToModal()">Añadir</button>
            </div>
            
            <hr style="margin: 20px 0;">

            <button class="confirm-btn" onclick="saveDayChanges()">Guardar Cambios</button>
        </div>
    </div>

    <script>
        let currentState = 'out';
        let todayData = {
            date: new Date().toISOString().split('T')[0],
            entries: [],
            workedMinutes: 0,
            lunchMinutes: 0,
            hadLunchOut: false
        };
        let pendingAction = null;
        let workTimer = null;

        const SCHEDULE = {
            weekday: {
                minEntry: { hour: 7, minute: 0 },
                maxEntry: { hour: 9, minute: 0 },
                minExit: { hour: 17, minute: 0 },
                maxExit: { hour: 19, minute: 0 },
                mandatoryStart: { hour: 9, minute: 0 },
                mandatoryEnd: { hour: 17, minute: 0 },
                lunchStart: { hour: 13, minute: 50 },
                lunchEnd: { hour: 14, minute: 30 },
                lunchReturnMin: { hour: 14, minute: 30 },
                lunchReturnMax: { hour: 15, minute: 30 },
                requiredMinutes: 510
            },
            friday: {
                minEntry: { hour: 7, minute: 30 },
                maxEntry: { hour: 8, minute: 30 },
                minExit: { hour: 13, minute: 50 },
                maxExit: { hour: 14, minute: 50 },
                mandatoryStart: { hour: 8, minute: 30 },
                mandatoryEnd: { hour: 13, minute: 50 },
                requiredMinutes: 360
            }
        };

        const OVERTIME_REASONS = {
            reunion_urgente: "Reunión urgente",
            proyecto_critico: "Proyecto crítico",
            problema_tecnico: "Problema técnico",
            cliente_importante: "Atención cliente importante",
            formacion: "Formación",
            otro: "Otro"
        };
        
        const ACTION_TEXT = {
            'enter': 'Entrada',
            'lunch_out': 'Salida comida',
            'lunch_back': 'Vuelta comida',
            'exit': 'Salida'
        };

        function initApp() {
            loadTodayData();
            
            const today = new Date().toISOString().split('T')[0];
            if (todayData.date !== today) {
                todayData = {
                    date: today,
                    entries: [],
                    workedMinutes: 0,
                    lunchMinutes: 0,
                    hadLunchOut: false
                };
                currentState = 'out';
            }

            updateDateTime();
            updateDisplay();
            updateButtons();
            
            if (currentState === 'in' || currentState === 'lunch_back') {
                startWorkTimer();
            }
            
            setInterval(updateDateTime, 1000);
        }

        function loadTodayData() {
            const today = new Date().toISOString().split('T')[0];
            const savedData = localStorage.getItem(`workday_${today}`);
            
            if (savedData) {
                todayData = JSON.parse(savedData);
                todayData.hadLunchOut = todayData.entries.some(e => e.type === 'lunch_out');
                
                if (todayData.entries.length > 0) {
                    const lastEntry = todayData.entries[todayData.entries.length - 1];
                    currentState = lastEntry.type === 'enter' ? 'in' :
                                lastEntry.type === 'lunch_out' ? 'lunch_out' :
                                lastEntry.type === 'lunch_back' ? 'lunch_back' : 'out';
                }
                
                calculateWorkedTime();
            } else {
                todayData.date = today;
            }
        }

        function saveTodayData() {
            localStorage.setItem(`workday_${todayData.date}`, JSON.stringify(todayData));
            saveWeeklyHistory();
        }

        function saveWeeklyHistory() {
            const dateToSave = new Date(todayData.date);
            const weekStart = getMonday(dateToSave);
            const weekKey = `week_${weekStart.toISOString().split('T')[0]}`;
            
            let weekData = JSON.parse(localStorage.getItem(weekKey) || '{}');
            weekData[todayData.date] = todayData;
            
            localStorage.setItem(weekKey, JSON.stringify(weekData));
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function updateDateTime() {
            const now = new Date();

            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('es-ES', dateOptions);

            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-ES', timeOptions);
        }
        
        function addManualEntry() {
            const type = document.getElementById('manualType').value;
            const timeStr = document.getElementById('manualTime').value;
            if (!timeStr) {
                showAlert('Introduce una hora válida', 'warning');
                return;
            }

            const [hours, minutes] = timeStr.split(':').map(Number);
            const entryDate = new Date();
            entryDate.setHours(hours, minutes, 0, 0);

            const tempEntries = [...todayData.entries, { type, time: entryDate.toISOString() }];
            tempEntries.sort((a, b) => new Date(a.time) - new Date(b.time));

            const typeOrder = { 'enter': 1, 'lunch_out': 2, 'lunch_back': 3, 'exit': 4 };
            let lastTypeOrder = 0;
            for (const entry of tempEntries) {
                const currentTypeOrder = typeOrder[entry.type];
                if (currentTypeOrder < lastTypeOrder) {
                    showAlert('El orden cronológico de los registros es incorrecto.', 'warning');
                    return;
                }
                lastTypeOrder = currentTypeOrder;
            }

            const isOvertime = isOvertimeAction(type, entryDate);
            
            if (isOvertime) {
                pendingAction = { type: type, time: entryDate };
                showOvertimeDialog();
            } else {
                executeAction(type, entryDate);
            }
        }

        function handleAction(action) {
            const now = new Date();
            const isOvertime = isOvertimeAction(action, now);
            
            if (isOvertime) {
                pendingAction = { type: action, time: now };
                showOvertimeDialog();
            } else {
                executeAction(action, now);
            }
        }

        function isOvertimeAction(action, time) {
            const dayOfWeek = time.getDay();
            const isFriday = dayOfWeek === 5;
            const schedule = isFriday ? SCHEDULE.friday : SCHEDULE.weekday;
            
            const hour = time.getHours();
            const minute = time.getMinutes();
            const totalMinutes = hour * 60 + minute;
            
            switch (action) {
                case 'enter':
                    const minEntry = schedule.minEntry.hour * 60 + schedule.minEntry.minute;
                    const maxEntry = schedule.maxEntry.hour * 60 + schedule.maxEntry.minute;
                    return totalMinutes < minEntry || totalMinutes > maxEntry;
                    
                case 'exit':
                    const minExit = schedule.minExit.hour * 60 + schedule.minExit.minute;
                    const maxExit = schedule.maxExit.hour * 60 + schedule.maxExit.minute;
                    return totalMinutes < minExit || totalMinutes > maxExit;
                    
                case 'lunch_back':
                    if (!isFriday) {
                        const lunchReturnMin = schedule.lunchReturnMin.hour * 60 + schedule.lunchReturnMin.minute;
                        const lunchReturnMax = schedule.lunchReturnMax.hour * 60 + schedule.lunchReturnMax.minute;
                        return totalMinutes < lunchReturnMin || totalMinutes > lunchReturnMax;
                    }
                    return false;
                    
                default:
                    return false;
            }
        }

        function showOvertimeDialog() {
            document.getElementById('overtimeSection').classList.add('active');
        }

        function confirmOvertimeAction() {
            const reason = document.getElementById('overtimeReason').value;
            const description = document.getElementById('overtimeDescription').value;
            
            if (!reason) {
                showAlert('Por favor selecciona un motivo', 'warning');
                return;
            }
            
            executeAction(pendingAction.type, pendingAction.time, true, reason, description);
            
            document.getElementById('overtimeSection').classList.remove('active');
            document.getElementById('overtimeReason').value = '';
            document.getElementById('overtimeDescription').value = '';
            pendingAction = null;
        }
        
        function executeAction(action, time, isOvertime = false, reason = '', description = '') {
            const existingEntryIndex = todayData.entries.findIndex(entry => entry.type === action);
            if (existingEntryIndex > -1) {
                todayData.entries.splice(existingEntryIndex, 1);
            }

            const entry = {
                type: action,
                time: time.toISOString(),
                hour: time.getHours(),
                minute: time.getMinutes(),
                isOvertime,
                reason,
                description
            };
            
            todayData.entries.push(entry);
            todayData.entries.sort((a, b) => new Date(a.time) - new Date(b.time));

            const lastEntry = todayData.entries[todayData.entries.length - 1];
            
            switch (lastEntry.type) {
                case 'enter':
                case 'lunch_back':
                    currentState = lastEntry.type === 'enter' ? 'in' : 'lunch_back';
                    startWorkTimer();
                    break;
                case 'lunch_out':
                    currentState = 'lunch_out';
                    todayData.hadLunchOut = true;
                    stopWorkTimer();
                    break;
                case 'exit':
                    currentState = 'out';
                    stopWorkTimer();
                    break;
            }
            
            showAlert(`${ACTION_TEXT[action]} registrada`, 'success');

            calculateWorkedTime();
            updateDisplay();
            updateButtons();
            saveTodayData();
        }

        function startWorkTimer() {
            if (workTimer) clearInterval(workTimer);
            workTimer = setInterval(() => {
                calculateWorkedTime();
                updateDisplay();
            }, 1000);
        }

        function stopWorkTimer() {
            if (workTimer) {
                clearInterval(workTimer);
                workTimer = null;
            }
        }

        function calculateWorkedTime() {
            let workedMinutes = 0;
            let currentPeriodStart = null;
            let hadEntry = todayData.entries.some(e => e.type === 'enter');
            todayData.hadLunchOut = todayData.entries.some(e => e.type === 'lunch_out');

            for (const entry of todayData.entries) {
                const entryTime = new Date(entry.time);

                if (entry.type === 'enter' || entry.type === 'lunch_back') {
                    currentPeriodStart = entryTime;
                } else if ((entry.type === 'lunch_out' || entry.type === 'exit') && currentPeriodStart) {
                    workedMinutes += (entryTime - currentPeriodStart) / (1000 * 60);
                    currentPeriodStart = null;
                }
            }

            if (currentPeriodStart && (currentState === 'in' || currentState === 'lunch_back')) {
                workedMinutes += (new Date() - currentPeriodStart) / (1000 * 60);
            }

            if (hadEntry && todayData.hadLunchOut) {
                workedMinutes = Math.max(0, workedMinutes - 20);
            }

            todayData.workedMinutes = Math.floor(workedMinutes);
        }

        function updateDisplay() {
            const isFriday = new Date().getDay() === 5;
            const requiredMinutes = isFriday ? SCHEDULE.friday.requiredMinutes : SCHEDULE.weekday.requiredMinutes;
            
            const statusText = {
                'out': 'Fuera',
                'in': 'Trabajando',
                'lunch_out': 'En Comida',
                'lunch_back': 'Trabajando'
            };
            
            const statusElement = document.getElementById('workStatus');
            statusElement.textContent = statusText[currentState];
            statusElement.className = 'status-value ' + (currentState === 'in' || currentState === 'lunch_back' ? 'working' : '');
            
            const workedHours = Math.floor(todayData.workedMinutes / 60);
            const workedMins = todayData.workedMinutes % 60;
            document.getElementById('workedHours').textContent = `${workedHours.toString().padStart(2, '0')}:${workedMins.toString().padStart(2, '0')}`;
            
            const remainingMinutes = Math.max(0, requiredMinutes - todayData.workedMinutes);
            const remainingHours = Math.floor(remainingMinutes / 60);
            const remainingMins = remainingMinutes % 60;
            
            const remainingElement = document.getElementById('remainingHours');
            if (todayData.workedMinutes >= requiredMinutes) {
                const overtimeMinutes = todayData.workedMinutes - requiredMinutes;
                const overtimeHours = Math.floor(overtimeMinutes / 60);
                const overtimeMins = overtimeMinutes % 60;
                remainingElement.textContent = `+${overtimeHours.toString().padStart(2, '0')}:${overtimeMins.toString().padStart(2, '0')}`;
                remainingElement.className = 'status-value overtime';
            } else {
                remainingElement.textContent = `${remainingHours.toString().padStart(2, '0')}:${remainingMins.toString().padStart(2, '0')}`;
                remainingElement.className = 'status-value';
            }
            
            const exitElement = document.getElementById('estimatedExit');

            // --- INICIO DE CAMBIO: Lógica de estimación de salida actualizada ---
            if (currentState === 'in') {
                exitElement.textContent = '--:--';
            } else if (currentState === 'lunch_out') {
                const lunchOutEntry = todayData.entries.find(e => e.type === 'lunch_out');
                if (lunchOutEntry) {
                    const lunchOutTime = new Date(lunchOutEntry.time);
                    const minReturn = new Date(lunchOutTime.getTime() + 40 * 60000 + remainingMinutes * 60000);
                    const maxReturn = new Date(lunchOutTime.getTime() + 100 * 60000 + remainingMinutes * 60000);

                    const format = d => `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
                    exitElement.textContent = `${format(minReturn)} - ${format(maxReturn)}`;
                } else {
                    exitElement.textContent = '--:--';
                }
            } else if (currentState === 'lunch_back') {
                const now = new Date();
                const estimatedExit = new Date(now.getTime() + remainingMinutes * 60000);
                const exitHour = estimatedExit.getHours().toString().padStart(2, '0');
                const exitMinute = estimatedExit.getMinutes().toString().padStart(2, '0');
                exitElement.textContent = `${exitHour}:${exitMinute}`;
            } else {
                exitElement.textContent = '--:--';
            }
            // --- FIN DE CAMBIO ---
        }

        function updateButtons() {
            const buttons = {
                enterBtn: document.getElementById('enterBtn'),
                lunchOutBtn: document.getElementById('lunchOutBtn'),
                lunchBackBtn: document.getElementById('lunchBackBtn'),
                exitBtn: document.getElementById('exitBtn')
            };
            
            Object.values(buttons).forEach(btn => btn.style.display = 'none');
            
            const hasEnter = todayData.entries.some(e => e.type === 'enter');
            const hasLunchOut = todayData.entries.some(e => e.type === 'lunch_out');
            const hasLunchBack = todayData.entries.some(e => e.type === 'lunch_back');
            const hasExit = todayData.entries.some(e => e.type === 'exit');
            const isFriday = new Date().getDay() === 5;
            
            if (hasExit) {
                // Jornada finalizada, no mostrar botones
            } else if (hasLunchBack) {
                buttons.exitBtn.style.display = 'block';
            } else if (hasLunchOut) {
                buttons.lunchBackBtn.style.display = 'block';
            } else if (hasEnter) {
                if (!isFriday) {
                    buttons.lunchOutBtn.style.display = 'block';
                }
                buttons.exitBtn.style.display = 'block';
            } else {
                buttons.enterBtn.style.display = 'block';
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function toggleManualEntry() {
            const manualEntryContent = document.getElementById('manualEntryContent');
            manualEntryContent.classList.toggle('active');
        }

        function toggleHistory() {
            const historyContent = document.getElementById('historyContent');
            const isVisible = historyContent.classList.contains('active');
            
            if (isVisible) {
                historyContent.classList.remove('active');
            } else {
                loadWeeklyHistory();
                historyContent.classList.add('active');
            }
        }

        function loadWeeklyHistory() {
            const today = new Date();
            const weekStart = getMonday(today);
            const weekKey = `week_${weekStart.toISOString().split('T')[0]}`;
            
            const weekData = JSON.parse(localStorage.getItem(weekKey) || '{}');
            const historyContent = document.getElementById('historyContent');
            
            let html = '<h3>Historial de la Semana</h3>';
            
            const todayStr = new Date().toISOString().split('T')[0];

            for (let i = 0; i < 5; i++) {
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                const dayKey = day.toISOString().split('T')[0];
                const dayData = weekData[dayKey];
                
                const dayName = day.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                
                html += `<div class="day-record">`;
                html += `<div class="day-header">
                            <span>${dayName}</span>`;

                if (dayKey <= todayStr) {
                    html += `<button class="add-btn" style="padding: 5px 10px;" onclick="openEditModal('${dayKey}')">Editar</button>`;
                }
                
                html += `</div>`;
                
                if (dayData && dayData.entries.length > 0) {
                    const workedHours = Math.floor(dayData.workedMinutes / 60);
                    const workedMins = dayData.workedMinutes % 60;
                    
                    html += `<div class="time-entry"><span>Horas trabajadas:</span><span>${workedHours.toString().padStart(2, '0')}:${workedMins.toString().padStart(2, '0')}</span></div>`;
                    
                    dayData.entries.forEach(entry => {
                        const timeStr = `${entry.hour.toString().padStart(2, '0')}:${entry.minute.toString().padStart(2, '0')}`;
                        
                        let entryClass = '';
                        let entryText = `<span>${ACTION_TEXT[entry.type]}:</span><span>${timeStr}</span>`;
                        
                        if (entry.isOvertime) {
                            entryClass = 'overtime-entry';
                            const reasonText = OVERTIME_REASONS[entry.reason] || entry.reason;
                            entryText += ` <small>(${reasonText})</small>`;
                        }
                        
                        html += `<div class="time-entry ${entryClass}">${entryText}</div>`;
                    });
                } else {
                    html += `<div class="time-entry"><span>Sin registros</span></div>`;
                }
                
                html += `</div>`;
            }
            
            historyContent.innerHTML = html;
        }

        function openEditModal(dayKey) {
            const modal = document.getElementById('editDayModal');
            modal.dataset.dayKey = dayKey;

            const weekStart = getMonday(new Date(dayKey));
            const weekKey = `week_${weekStart.toISOString().split('T')[0]}`;
            const weekData = JSON.parse(localStorage.getItem(weekKey) || '{}');
            let dayData = weekData[dayKey];

            if (!dayData) {
                dayData = { date: dayKey, entries: [], workedMinutes: 0 };
            }

            const modalTitle = document.getElementById('editDayModalTitle');
            const dayName = new Date(dayKey).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            modalTitle.textContent = `Editar Jornada: ${dayName}`;

            const container = document.getElementById('existingEntriesContainer');
            let html = '<h4>Registros Existentes</h4>';
            let entryTypes = new Set();
            if (dayData.entries && dayData.entries.length > 0) {
                dayData.entries.forEach((entry, index) => {
                    entryTypes.add(entry.type);
                    const timeStr = `${entry.hour.toString().padStart(2, '0')}:${entry.minute.toString().padStart(2, '0')}`;
                    html += `
                        <div class="edit-entry" data-index="${index}">
                            <label>${ACTION_TEXT[entry.type]}:</label>
                            <input type="time" value="${timeStr}">
                            <button class="delete-btn" onclick="this.parentElement.remove()">Eliminar</button>
                            <input type="hidden" value="${entry.type}">
                        </div>
                    `;
                });
            } else {
                html += '<p>No hay registros para este día.</p>';
            }
            container.innerHTML = html;

            const addNewSection = document.getElementById('addNewEntrySection');
            const hasAllEntries = ['enter', 'lunch_out', 'lunch_back', 'exit'].every(type => entryTypes.has(type));
            
            if (hasAllEntries) {
                addNewSection.style.display = 'none';
            } else {
                addNewSection.style.display = 'block';
            }

            modal.style.display = "block";
        }

        function closeEditModal() {
            const modal = document.getElementById('editDayModal');
            modal.style.display = "none";
        }
        
        // --- INICIO DE CAMBIO: `addNewEntryToModal` corregida para evitar errores ---
        function addNewEntryToModal() {
            const type = document.getElementById('newEntryType').value;
            const time = document.getElementById('newEntryTime').value;

            if (!time) {
                showAlert('Por favor, introduce una hora.', 'warning');
                return;
            }

            const container = document.getElementById('existingEntriesContainer');
            const noRecordsP = container.querySelector('p');
            if (noRecordsP) noRecordsP.remove();
            
            const newEntryDiv = document.createElement('div');
            newEntryDiv.className = 'edit-entry';
            newEntryDiv.dataset.index = 'new';

            const label = document.createElement('label');
            label.textContent = `${ACTION_TEXT[type]}:`;

            const timeInput = document.createElement('input');
            timeInput.type = 'time';
            timeInput.value = time;

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'Eliminar';
            deleteBtn.onclick = () => newEntryDiv.remove();

            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.value = type;

            newEntryDiv.appendChild(label);
            newEntryDiv.appendChild(timeInput);
            newEntryDiv.appendChild(deleteBtn);
            newEntryDiv.appendChild(hiddenInput);

            container.appendChild(newEntryDiv);
            
            document.getElementById('newEntryTime').value = '';
        }
        // --- FIN DE CAMBIO ---

        function saveDayChanges() {
            const modal = document.getElementById('editDayModal');
            const dayKey = modal.dataset.dayKey;

            const weekStart = getMonday(new Date(dayKey));
            const weekKey = `week_${weekStart.toISOString().split('T')[0]}`;
            const weekData = JSON.parse(localStorage.getItem(weekKey) || '{}');
            
            const newEntries = [];
            const entryElements = document.querySelectorAll('#existingEntriesContainer .edit-entry');
            
            entryElements.forEach(el => {
                const timeStr = el.querySelector('input[type="time"]').value;
                const type = el.querySelector('input[type="hidden"]').value;
                const [hour, minute] = timeStr.split(':').map(Number);
                
                const entryDate = new Date(dayKey + 'T00:00:00.000Z');
                entryDate.setUTCHours(hour, minute, 0, 0);

                newEntries.push({
                    type: type,
                    time: entryDate.toISOString(),
                    hour: hour,
                    minute: minute,
                    isOvertime: false,
                    reason: '',
                    description: ''
                });
            });

            newEntries.sort((a, b) => new Date(a.time) - new Date(b.time));

            let dayData = weekData[dayKey] || { date: dayKey, entries: [] };
            dayData.entries = newEntries;
            
            dayData = recalculateWorkedTimeForDay(dayData);
            
            weekData[dayKey] = dayData;
            localStorage.setItem(weekKey, JSON.stringify(weekData));
            
            if (dayKey === todayData.date) {
                localStorage.setItem(`workday_${dayKey}`, JSON.stringify(dayData));
                loadTodayData();
                updateDisplay();
                updateButtons();
            }

            showAlert('Jornada actualizada correctamente', 'success');
            closeEditModal();
            loadWeeklyHistory();
        }

        function recalculateWorkedTimeForDay(dayData) {
            dayData.entries.sort((a, b) => new Date(a.time) - new Date(b.time));
            let workedMinutes = 0;
            let currentPeriodStart = null;
            let hadEntry = false;
            dayData.hadLunchOut = dayData.entries.some(e => e.type === 'lunch_out');

            for (const entry of dayData.entries) {
                const entryTime = new Date(entry.time);
                if (entry.type === 'enter' || entry.type === 'lunch_back') {
                    currentPeriodStart = entryTime;
                    if (entry.type === 'enter') hadEntry = true;
                } else if ((entry.type === 'lunch_out' || entry.type === 'exit') && currentPeriodStart) {
                    workedMinutes += (entryTime - currentPeriodStart) / (1000 * 60);
                    currentPeriodStart = null;
                }
            }

            if (hadEntry && dayData.hadLunchOut) {
                workedMinutes = Math.max(0, workedMinutes - 20);
            }

            dayData.workedMinutes = Math.floor(workedMinutes);
            return dayData;
        }

        function exportWeekToExcel() {
            const today = new Date();
            const weekStart = getMonday(today);
            const weekKey = `week_${weekStart.toISOString().split('T')[0]}`;
            
            const weekData = JSON.parse(localStorage.getItem(weekKey) || '{}');

            if (Object.keys(weekData).length === 0) {
                showAlert('No hay datos para exportar en la semana actual.', 'warning');
                return;
            }

            const rows = [['Fecha', 'Hora', 'Tipo', 'Motivo', 'Descripción', 'Horas Totales']];
            
            const sortedDays = Object.keys(weekData).sort((a, b) => new Date(a) - new Date(b));

            for (const dayKey of sortedDays) {
                const dayData = weekData[dayKey];
                const workedHours = Math.floor(dayData.workedMinutes / 60);
                const workedMins = dayData.workedMinutes % 60;
                const workedTimeStr = `${workedHours.toString().padStart(2, '0')}:${workedMins.toString().padStart(2, '0')}`;

                if (dayData.entries.length > 0) {
                    dayData.entries.forEach((entry, index) => {
                        const timeStr = `${entry.hour.toString().padStart(2, '0')}:${entry.minute.toString().padStart(2, '0')}`;
                        const reasonText = entry.isOvertime ? (OVERTIME_REASONS[entry.reason] || entry.reason) : '';
                        
                        rows.push([
                            dayKey,
                            timeStr,
                            ACTION_TEXT[entry.type],
                            reasonText,
                            entry.description,
                            index === dayData.entries.length - 1 ? workedTimeStr : ''
                        ]);
                    });
                } else {
                    rows.push([dayKey, '', 'Sin registros', '', '', '00:00']);
                }
                rows.push([]);
            }

            const worksheet = XLSX.utils.aoa_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Jornada Semanal');
            
            const colWidths = rows[0].map((_, i) => ({
                wch: Math.max(...rows.map(row => (row[i] || '').toString().length)) + 2
            }));
            worksheet['!cols'] = colWidths;

            XLSX.writeFile(workbook, `jornada_semanal_${weekStart.toISOString().split('T')[0]}.xlsx`);
        }

        document.addEventListener('DOMContentLoaded', initApp);
        
        window.addEventListener('beforeunload', () => {
            if (workTimer) {
                clearInterval(workTimer);
            }
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('editDayModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>